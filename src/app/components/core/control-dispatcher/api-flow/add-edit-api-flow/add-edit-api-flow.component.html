<div class="container is-fluid">
<div class="navbar-item">
    <nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
        <li>
        <a (click)="navigateToList()">Control API Flow/Entrypoints</a>
        </li>
        <li class="is-active">
        <a href="#" aria-current="page">{{ editMode ? _name : 'Add' }}</a>
        </li>
    </ul>
    </nav>
    <button type="button" *ngIf="editMode" (click)="getAPIFlow()" class="button is-small" title="Reload" id="refresh-check">
        <i class="fa fa-xs fa-sync" aria-hidden="true"></i>
    </button>
    
    <!-- show Request/Execute button in top right; Check user's permissions if not anonymous -->
    <button  *ngIf="editMode" (click)="openModal('request-dialog')" type="button" class="button is-small is-link is-light">Request/Execute</button>
</div>

<div class="card">
    <div class="card-content">
    <form [formGroup]="apiFlowForm">
        <!-- TODO: FOGL-?
        <span (click)="goToLink()"
        class=" icon is-small has-tooltip-top has-tooltip-arrow tooltip is-pulled-right is-hovered help-icon" data-tooltip="Help">
            <i class="far fa-question-circle"></i>
        </span> -->
        <div class="column">
        <div [hidden]="editMode" class="field is-horizontal">
            <div class="field-label">
            <label class="label label-name">Name</label>
            </div>
            <div class="field-body">
            <div class="field">
                <div class="control">
                <input #name=ngModel name="_name" class="input" type="text" placeholder="Name" required
                    [(ngModel)]="_name" title="No single quotes and double quotes!" [ngModelOptions]="{standalone: true}"
                    [pattern]="QUOTATION_VALIDATION_PATTERN" autocomplete="off"
                    [ngClass]="{'is-small':rolesService.hasControlAccess(), 'is-static static-field':!rolesService.hasControlAccess()}"
                    [readonly]="!rolesService.hasControlAccess()">
                </div>
                <div *ngIf="name.invalid && (name.dirty || name.touched)" class="help is-danger">
                <div *ngIf="name.errors?.['required']">
                    *required
                </div>
                </div>
            </div>
            </div>
        </div>
        <div class="field is-horizontal">
            <div class="field-label">
            <label class="label label-name">Type</label>
            </div>
            <div class="field-body">
            <div class="field" *ngIf="rolesService.hasControlAccess(); else staticTypeDiv">
                <div class="control">
                <div id="type-dropdown" class="dropdown is-left">
                    <div class="dropdown-trigger">
                        <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu"
                            (click)="toggleDropdown('type-dropdown')" placeholder="Select">
                            <span>{{selectedType}}</span>
                            <span class="icon is-small">
                            <i class="fa fa-sm fa-angle-down" aria-hidden="true"></i>
                            </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        <a (click)="selectValue('Operation', 'type');toggleDropdown('type-dropdown')"
                        class="dropdown-item">Operation</a>
                        <a (click)="selectValue('Write', 'type');toggleDropdown('type-dropdown')"
                        class="dropdown-item">Write</a>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            <ng-template #staticTypeDiv>
                <div class="field">
                <div class="control">
                    <input name="type" class="input is-static static-fiel" type="text" [value]="selectedType" readonly>
                </div>
                </div>
            </ng-template>
            </div>
        </div>

        <!-- TODO: Show only if selected type is operation-->
        <div class="field is-horizontal">
            <div class="field-label">
                <label class="label label-name">Operation</label>
            </div>
            
            <div class="field-body">
                <div class="field">
                        <!-- Operation name -->
                        <!-- <input name="type" class="input is-small" type="text" [value]="af.operation_name"> -->
                </div>
            </div>
        </div>

        <div class="field is-horizontal">
            <div class="field-label">
            <label class="label label-name">Destination</label>
            </div>
            <div class="field-body">
            <div class="field">
                <div class="field is-horizontal">
                <div class="field-body">
                    <div class="field">
                    <div class="control box">
                        <div class="columns">
                        <div class="column">
                            <div class="field is-horizontal">
                                <div class="field-label is-small">
                                    <label class="label is-small">Type</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control"
                                            *ngIf="rolesService.hasControlAccess(); else staticDestinationType">
                                            <ng-select [clearable]="false" placeholder="Select Destination Type"
                                                [items]="destinationTypeList" [multiple]="false" bindLabel="name"
                                                (change)="getDestinationNameList($event)"
                                                [ngModel]="selectedDestinationType.name" [ngModelOptions]="{standalone: true}">
                                            </ng-select>
                                        </div>
                                        <ng-template #staticDestinationType>
                                            <input name="destinationType" class="input" type="text"
                                            [value]="selectedDestinationType.name ? selectedDestinationType.name : 'Select Destination Name'"
                                            [ngClass]="{'is-static':!rolesService.hasControlAccess(), 'has-text-grey-light is-size-7':!selectedDestinationType.name}"
                                            [readonly]="!rolesService.hasControlAccess()">
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="selectedDestinationType?.name && !(selectedDestinationType.name === 'Any' || selectedDestinationType.name === 'Broadcast')"
                            class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label is-small">Name</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                <div class="control"
                                    *ngIf="rolesService.hasControlAccess(); else staticDestinationName">
                                    <ng-select [clearable]="false" placeholder="Select Destination"
                                    [items]="destinationNameList" [multiple]="false" bindLabel="name"
                                    groupBy="groupbyType" (change)="selectDestinationName($event.name)"
                                    [ngModel]="selectedDestinationName" [ngModelOptions]="{standalone: true}">
                                    </ng-select>
                                </div>
                                <div *ngIf="!selectedDestinationName && selectedDestinationType"
                                    class="help is-danger">
                                    *required
                                </div>
                                <ng-template #staticDestinationName>
                                    <input name="destinationName" class="input" type="text"
                                    [value]="selectedDestinationName ? selectedDestinationName : 'Select Destination Name'"
                                    [ngClass]="{'is-static':!rolesService.hasControlAccess(), 'has-text-grey-light is-size-7':!selectedDestinationName}"
                                    [readonly]="!rolesService.hasControlAccess()">
                                </ng-template>
                                </div>
                            </div>
                            </div>
                        </div>
                        <div class="column is-1">
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>

        <ng-container formArrayName="variables">
            <div class="field is-horizontal" *ngFor="let v of getFormControls('variables'); let i = index">
                <div *ngIf="i == 0" class="field-label">
                    <label class="label">Variables</label>
                </div>
                <!-- <div *ngIf="i > 0" class="field-label">
                    <label class="label"></label>
                </div> -->
                <div class="field-body" [formGroupName]="i">
                    <div class="field" style="max-width: 20%;">
                        <div class="control">
                            <input formControlName="vName" placeholder="Variable name" class="input is-small"
                            name="type" type="text">
                        </div>
                    </div>
                <div class="field" style="max-width: 50%;">
                    <div class="control">
                        <input formControlName="vValue" placeholder="Variable value" class="input is-small" name="value" type="text">
                    </div>
                </div>
                </div>
            </div>
        </ng-container>

        <ng-container formArrayName="constants">
            <div class="field is-horizontal" *ngFor="let c of getFormControls('constants'); let i = index">
                <div *ngIf="i == 0" class="field-label">
                <label class="label">Constants</label>
                </div>
                <div *ngIf="i > 0" class="field-label">
                <label class="label"></label>
                </div>
                <div class="field-body" [formGroupName]="i">
                <div class="field" style="max-width: 20%;">
                    <div class="control">
                    <input formControlName="cName" placeholder="Constant name" class="input is-small"
                        name="type" type="text">
                    </div>
                </div>
                <div class="field" style="max-width: 50%;">
                    <div class="control">
                    <input formControlName="cValue" placeholder="Constant value" class="input is-small" name="value" type="text">
                    </div>
                </div>
                </div>
            </div>
        </ng-container>

        <div class="field is-horizontal">
            <div class="field-label">
            <label class="label label-name" title="Access to execute the entrypoint">Anonymous</label>
            </div>
            <div class="field-body">
            <!-- <div class="field">
                <input class="checkbox" [disabled]="!rolesService.hasControlAccess()" type="checkbox"
                [checked]="af.anonymous" (click)="onCheckboxClicked($event)">
            </div> -->
            </div>
        </div>
        

        <div class="field is-horizontal">
        <div class="field-label">
            <label class="label label-name" title="Username' list">Allowed Users</label>
        </div>
        <div class="field-body">
            <div class="field">
            <!--- Show multi-select dropdown to allow choose Username/s-->
            </div>
        </div>
        </div>


        <div *ngIf="rolesService.hasControlAccess()" class="column footer-padding">
        <div class="columns">
            <div class="column is-2"></div>
            <div class="column" *ngIf="editMode">
            <div class="field is-grouped control-pad">
                <p class="control">
                <button (click)="openModal('confirmation-dialog')" type="button"
                    class="button is-small is-danger is-outlined">Delete</button>
                </p>
            </div>
            </div>
            <div class="column">
            <div class="field is-grouped is-pulled-right">
                <p class="control">
                <button class="button is-small" type="button" (click)="onCancel()">Cancel</button>
                </p>
                <p class="control">
                <button (click)="onSubmit(apiFlowForm)" type="submit" class="button is-small"
                    [disabled]="apiFlowForm?.invalid">Save</button>
                </p>
            </div>
            </div>
        </div>
        </div>
        </div>

    </form>
    </div>
</div>

</div>

<app-confirmation-dialog id="confirmation-dialog">
<header class="modal-card-head">
    <p class="modal-card-title is-size-6">Delete</p>
    <button type="button" class="delete" aria-label="close" (click)="closeModal('confirmation-dialog')"></button>
</header>
<section class="modal-card-body">
    Are you sure, you want to delete this Control API Entrypoint <b>{{name}}</b>?
</section>
<footer class="modal-card-foot">
    <button class="button is-small" type="button" (click)="closeModal('confirmation-dialog')">Cancel</button>
    <button class="button is-small is-danger" type="button" (click)="deleteAPIFlow()">Delete</button>
</footer>
</app-confirmation-dialog>

<!-- field-label should use has-text-left?-->